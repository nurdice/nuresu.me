<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>Nur | Mission Control</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Poppins', sans-serif;
            user-select: none;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .label {
            position: absolute;
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            pointer-events: auto;
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
            transform: translate(-50%, -50%);
            white-space: nowrap;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            text-align: center;
        }

        .label:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .label.major {
            font-size: 22px;
            letter-spacing: 1px;
            text-transform: uppercase;
            background: transparent;
            border: none;
        }

        #overlay-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 400px;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            transform: translateX(100%);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: 40px;
            box-sizing: border-box;
            border-left: 1px solid rgba(255,255,255,0.1);
            color: #e2e8f0;
            overflow-y: auto;
            pointer-events: auto;
        }

        #overlay-panel.active {
            transform: translateX(0);
        }

        #overlay-panel h2 {
            font-size: 36px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #overlay-panel h3 {
            color: #94a3b8;
            font-size: 18px;
            margin-bottom: 30px;
            font-weight: 400;
        }

        .content-block {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
        }

        .close-btn:hover { opacity: 1; }

        #controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            pointer-events: auto;
            z-index: 20;
            flex-wrap: wrap;
        }

        .hud-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hud-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
        }

        #loading {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 1s;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #38bdf8;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            #overlay-panel { width: 100%; }
            .hud-btn { padding: 8px 16px; font-size: 12px; }
        }

        #sky-details {
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 15;
            display: none;
            width: 80%;
            max-width: 700px;
            animation: fadeIn 1s ease-out;
        }
        #sky-details h1 {
            font-size: 52px;
            margin-bottom: 20px;
            color: #38bdf8;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        #sky-content {
            font-size: 16px;
            line-height: 1.5;
            background: rgba(15, 23, 42, 0.7);
            padding: 25px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            white-space: pre-wrap;
            pointer-events: auto;
        }
        #sky-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
            pointer-events: auto;
        }
        #sky-close:hover { background: rgba(255, 255, 255, 0.3); }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes simpleFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile View Styles */
        #mobile-view {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #05050c;
            color: #f0f0ff;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', Courier, monospace;
            overflow-y: auto;
            z-index: 2000; /* Above loading screen initially */
        }
        .mobile-header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #1e293b; padding-bottom: 20px; }
        .mobile-header h1 { color: #38bdf8; font-size: 24px; margin: 0 0 10px 0; }
        .mobile-header h2 { font-size: 16px; color: #94a3b8; margin: 0 0 15px 0; }
        .mobile-contact { 
            font-size: 14px; 
            color: #94a3b8; 
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .mobile-contact a { color: #38bdf8; text-decoration: none; }
        .contact-separator { display: inline; opacity: 0.4; }
        .contact-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            align-items: center;
        }
        .mobile-buttons { 
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex; 
            flex-direction: row; 
            gap: 15px; 
            justify-content: center; 
            padding: 0 20px;
            background: transparent;
            border: none;
            box-sizing: border-box;
            z-index: 2001;
            pointer-events: none;
        }
        .mobile-buttons button {
            flex: 1;
            max-width: 250px;
            padding: 14px;
            border-radius: 30px;
            color: white;
            font-family: inherit;
            font-weight: bold;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            transition: transform 0.2s;
        }
        .mobile-buttons button:active { transform: scale(0.96); }
        #mobile-view section { margin-bottom: 30px; }
        #mobile-view h3 {
            border-bottom: 1px solid #1e293b;
            padding-bottom: 5px;
            margin-bottom: 15px;
            font-size: 20px;
            letter-spacing: 1px;
        }
        .job-block, .project-block, .edu-block, .skill-block { margin-bottom: 20px; }
        #mobile-view h4 { margin: 0 0 5px 0; font-size: 18px; }
        .job-meta { font-size: 14px; margin-bottom: 10px; font-style: italic; }
        #mobile-view ul { margin: 0; padding-left: 20px; }
        #mobile-view li { margin-bottom: 8px; font-size: 16px; line-height: 1.6; }
        #mobile-view p { font-size: 16px; line-height: 1.6; margin: 0 0 15px 0; }

        /* Desktop Fallback Layout */
        .resume-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 20px 120px 20px;
            animation: simpleFadeIn 0.8s ease-out;
        }
        .resume-grid {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }
        
        @media (min-width: 900px) {
            .resume-container {
                padding: 40px 40px 120px 40px;
            }
            .resume-grid {
                display: grid;
                grid-template-columns: 320px 1fr;
                gap: 40px;
                align-items: start;
            }
            .resume-sidebar {
                border-right: 1px solid var(--border-color);
                padding-right: 30px;
                order: 0;
            }
            .resume-main {
                order: 0;
            }
            .mobile-header {
                display: grid;
                grid-template-columns: 320px 1fr;
                gap: 40px;
                align-items: center;
                text-align: left !important;
            }
            .header-image-container {
                text-align: right;
                padding-right: 30px;
            }
            .mobile-contact {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 12px;
                align-items: center;
            }
            .contact-group { display: contents; }
        }
        
        #back-to-top {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2002;
            backdrop-filter: blur(5px);
            font-size: 18px;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        #back-to-top:active { transform: scale(0.9); }

        @media (max-width: 899px) {
            .resume-sidebar {
                order: 2;
                margin-top: 40px;
            }
            .resume-main {
                order: 1;
            }
        }

        @media print {
            .mobile-buttons, #controls, .hud-btn, #sky-details, #ui-layer, #loading, .mobile-header button {
                display: none !important;
            }
            #mobile-view {
                position: relative;
                height: auto;
                overflow: visible;
                background: white !important;
                color: black !important;
            }
            .resume-container {
                width: 100%;
                max-width: none;
                padding: 0;
                margin: 0;
            }
            body {
                background: white !important;
                overflow: visible;
            }
        }
    </style>
</head>
<body>

    <div id="loading"><div class="loader"></div></div>
    <div id="mobile-view"></div>
    <div id="canvas-container"></div>
    <div id="ui-layer"></div>
    <div id="sky-details">
        <div id="sky-close" onclick="resetView()">‚úï</div>
        <h1 id="sky-title">Moon Title</h1>
        <div id="sky-content">Details go here...</div>
    </div>

    <div id="pdf-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; justify-content:center; align-items:center;">
        <div style="background:rgba(15, 23, 42, 0.95); padding:40px; border-radius:20px; border:1px solid rgba(255,255,255,0.1); text-align:center; backdrop-filter:blur(10px); max-width: 400px; width: 90%;">
            <h2 style="color:#38bdf8; margin-top:0;">Download Resume</h2>
            <p style="color:#cbd5e1; margin-bottom:30px;">Choose a style for your PDF resume:</p>
            
            <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap;">
                <button onclick="generatePDF('professional')" style="
                    background: #e2e8f0; color: #0f172a; border:none; padding:12px 24px; border-radius:8px; 
                    cursor:pointer; font-weight:600; font-family:'Poppins',sans-serif; transition:transform 0.2s;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    Professional
                </button>
                
                <button onclick="generatePDF('space')" style="
                    background: linear-gradient(135deg, #38bdf8, #818cf8); color: white; border:none; padding:12px 24px; border-radius:8px; 
                    cursor:pointer; font-weight:600; font-family:'Poppins',sans-serif; transition:transform 0.2s;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    Space Theme
                </button>
            </div>
            
            <button onclick="document.getElementById('pdf-modal').style.display='none'" style="margin-top:30px; background:transparent; border:1px solid rgba(255,255,255,0.3); color:rgba(255,255,255,0.7); padding:8px 16px; border-radius:20px; cursor:pointer;">
                Cancel
            </button>
        </div>
    </div>

    <div id="overlay-panel">
        <button class="close-btn" onclick="closeOverlay()">√ó</button>
        <h2 id="panel-title">Title</h2>
        <h3 id="panel-subtitle">Subtitle</h3>
        <div id="panel-content"></div>
    </div>

    <div id="controls">
        <button class="hud-btn" onclick="resetView()">‚äô Reset View</button>
        <button class="hud-btn" onclick="toggleSound()" id="sound-btn">üîá Sound Off</button>
        <button class="hud-btn" onclick="document.getElementById('pdf-modal').style.display='flex'">üìÑ PDF Resume</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="resume_data.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@r128",
                "three/addons/controls/OrbitControls.js": "https://esm.sh/three@r128/examples/jsm/controls/OrbitControls.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const RESUME_DATA = window.RESUME_DATA;
        const { jsPDF } = window.jspdf;


        // === STATE VARIABLES (MUST BE DECLARED FIRST) ===
        const objects = [];
        const clickableObjects = [];
        const labels = [];
        let focusedObject = null;
        let isSunView = false;
        let soundEnabled = false;
        let backgroundAudio = null;
        const comets = [];
        const cometParticles = [];
        const lasers = [];

        // === SETUP THREE.JS (BEFORE ANYTHING ELSE) ===
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        
        function startFallbackMode(errorMessage = null) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('canvas-container').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            
            const container = document.getElementById('mobile-view');
            container.style.display = 'block';
            
            container.addEventListener('scroll', () => {
                const btn = document.getElementById('back-to-top');
                if (btn) {
                    btn.style.display = container.scrollTop > 300 ? 'flex' : 'none';
                }
            });

            window.renderMobileView = (theme) => {
                const isSpace = theme === 'space';
                
                const linkColor = isSpace ? '#38bdf8' : '#2563eb';
                const borderColor = isSpace ? '#1e293b' : '#e2e8f0';
                const headerColor = isSpace ? '#38bdf8' : '#0f172a';
                const subHeaderColor = isSpace ? '#94a3b8' : '#64748b';
                const sectionTitleColor = isSpace ? '#38bdf8' : '#0f172a';
                const itemTitleColor = isSpace ? '#e2e8f0' : '#334155';

                // Theme Styles
                container.style.backgroundColor = isSpace ? '#05050c' : '#ffffff';
                container.style.color = isSpace ? '#f0f0ff' : '#1e293b';
                container.style.fontFamily = isSpace ? "'Courier New', Courier, monospace" : "'Poppins', sans-serif";
                container.style.setProperty('--border-color', borderColor);
                
                // Background effect for space
                if (isSpace) {
                    container.style.backgroundImage = "radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px), radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px), radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px)";
                    container.style.backgroundSize = "550px 550px, 350px 350px, 250px 250px";
                    container.style.backgroundPosition = "0 0, 40px 60px, 130px 270px";
                } else {
                    container.style.backgroundImage = "none";
                }

                const titles = isSpace ? {
                    summary: "MISSION OBJECTIVE & PROFILE",
                    experience: "FLIGHT LOG & MISSION HISTORY",
                    skills: "OPERATIONAL SUBSYSTEMS",
                    projects: "DEPLOYED PAYLOADS",
                    education: "ACADEMIC & TRAINING DATA"
                } : {
                    summary: "SUMMARY",
                    experience: "PROFESSIONAL EXPERIENCE",
                    skills: "SKILLS & COMPETENCIES",
                    projects: "KEY PROJECTS",
                    education: "EDUCATION"
                };

                const profileImg = isSpace ? (RESUME_DATA.profileImageDark || RESUME_DATA.profileImage) : (RESUME_DATA.profileImageLight || RESUME_DATA.profileImage);

                let html = `
                    ${errorMessage ? `<div style="position: sticky; top: 0; z-index: 3000; background: rgba(220, 38, 38, 0.4); color: white; padding: 8px 10px; text-align: center; font-family: sans-serif; font-size: 11px; margin: 0; border-bottom: 1px solid rgba(255, 100, 100, 0.3); backdrop-filter: blur(12px); line-height: 1.3;">
                        <strong style="display:block; font-size:13px; margin-bottom:2px;">‚ö†Ô∏è 3D View Unavailable</strong>
                        ${errorMessage}
                    </div>` : ''}

                    <div class="resume-container" style="padding-top: ${errorMessage ? '140px' : '80px'}">
                    
                    <!-- Header -->
                    <div class="mobile-header" style="border-bottom: 1px solid ${borderColor}">
                        <div class="header-image-container">
                            <img src="${profileImg}" style="width: 160px; height: 160px; border-radius: 50%; border: 4px solid ${borderColor}; object-fit: cover;">
                        </div>
                        <div class="header-content">
                            <h1 style="color:${headerColor}; font-size: 32px; margin: 0 0 20px 0; line-height: 1.2;">${RESUME_DATA.name.toUpperCase()}</h1>
                            <h2 style="color:${subHeaderColor}; font-size: 20px; margin: 0 0 20px 0;">${RESUME_DATA.role}</h2>
                            <div class="mobile-contact" style="color:${subHeaderColor}">
                                <div class="contact-group">
                                    <span>üìß ${RESUME_DATA.contact.email}</span>
                                    <span class="contact-separator">|</span>
                                    <span>üì± ${RESUME_DATA.contact.phone}</span>
                                </div>
                                <div class="contact-group">
                                    <span>üìç ${RESUME_DATA.contact.location}</span>
                                    <span class="contact-separator">|</span>
                                    <span>üîó <a href="https://${RESUME_DATA.contact.linkedin}" target="_blank" style="color:${linkColor}">LinkedIn</a></span>
                                    <span class="contact-separator">|</span>
                                    <span>üåê <a href="https://${RESUME_DATA.contact.website}" target="_blank" style="color:${linkColor}">Website</a></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="resume-grid">
                        <!-- Sidebar (Skills, Education) -->
                        <div class="resume-sidebar">
                `;

                // --- SIDEBAR CONTENT ---
                let sidebarHtml = "";
                
                // Skills
                const skills = RESUME_DATA.planets.find(p => p.name === "Skills");
                if (skills) {
                    sidebarHtml += `<section><h3 style="color:${sectionTitleColor}; border-bottom: 1px solid ${borderColor}">${titles.skills}</h3>`;
                    skills.moons.forEach(cat => {
                        const d = isSpace ? (cat.spaceDetails || cat.pdfDetails || {}) : (cat.pdfDetails || cat.moonDetails || {});
                        sidebarHtml += `<div class="skill-block"><h4 style="color:${itemTitleColor}">${d.title || cat.name}</h4><p>${(d.skills || []).join(', ')}</p></div>`;
                    });
                    sidebarHtml += `</section>`;
                }

                // Education
                const eduPlanet = RESUME_DATA.planets.find(p => p.name === "Education");
                if (eduPlanet) {
                    sidebarHtml += `<section><h3 style="color:${sectionTitleColor}; border-bottom: 1px solid ${borderColor}">${titles.education}</h3>`;
                    const d = isSpace ? (eduPlanet.spaceDetails || eduPlanet.pdfDetails || eduPlanet.details || {}) : (eduPlanet.pdfDetails || eduPlanet.details || {});
                    const items = d.items || [d];
                    items.forEach(item => {
                        let eduInfo = item.institution || "";
                        if (item.university) eduInfo += `<br>${item.university}`;
                        if (item.year || item.duration) eduInfo += `<br><span style="font-size:0.9em; opacity:0.8">${item.year || item.duration}</span>`;
                        sidebarHtml += `<div class="edu-block"><h4 style="color:${itemTitleColor}">${item.degree}</h4><p>${eduInfo}</p></div>`;
                    });
                    sidebarHtml += `</section>`;
                }

                html += sidebarHtml + `</div> <!-- End Sidebar -->

                        <!-- Main Content (Summary, Experience, Projects) -->
                        <div class="resume-main">
                `;

                // --- MAIN CONTENT ---
                let mainHtml = "";

                // Summary
                const summaryText = isSpace ? (RESUME_DATA.spaceSummary || RESUME_DATA.summary) : (RESUME_DATA.pdfSummary || RESUME_DATA.summary);
                mainHtml += `<section><h3 style="color:${sectionTitleColor}; border-bottom: 1px solid ${borderColor}">${titles.summary}</h3><p>${summaryText}</p></section>`;

                // Experience
                const exp = RESUME_DATA.planets.find(p => p.name === "Experience");
                if (exp) {
                    mainHtml += `<section><h3 style="color:${sectionTitleColor}; border-bottom: 1px solid ${borderColor}">${titles.experience}</h3>`;
                    exp.moons.forEach(job => {
                        const d = isSpace ? (job.spaceDetails || job.pdfDetails || {}) : (job.pdfDetails || job.moonDetails || {});
                        mainHtml += `<div class="job-block">
                            <h4 style="color:${itemTitleColor}">${d.company || job.name}</h4>
                            <div class="job-meta" style="color:${subHeaderColor}">${d.role} | ${d.duration}</div>
                            <ul>${(d.achievements || []).map(a => `<li>${a}</li>`).join('')}</ul>
                        </div>`;
                    });
                    mainHtml += `</section>`;
                }

                // Projects
                const projects = RESUME_DATA.planets.find(p => p.name === "Shipped Products") || RESUME_DATA.planets.find(p => p.name === "Projects");
                if (projects) {
                    mainHtml += `<section><h3 style="color:${sectionTitleColor}; border-bottom: 1px solid ${borderColor}">${titles.projects}</h3>`;
                    projects.moons.forEach(p => {
                        const d = isSpace ? (p.spaceDetails || p.pdfDetails || {}) : (p.pdfDetails || p.moonDetails || {});
                        mainHtml += `<div class="project-block"><h4 style="color:${itemTitleColor}">${d.title || p.name}</h4><p>${d.description}</p><p><strong>Impact:</strong> ${(d.impact || []).join('. ')}</p></div>`;
                    });
                    mainHtml += `</section>`;
                }
                
                html += mainHtml + `</div> <!-- End Main -->
                    </div> <!-- End Grid -->
                </div> <!-- End Container -->`;

                // Button Styles
                const commonBtnStyle = "cursor: pointer; font-family: inherit; font-weight: bold; transition: transform 0.2s; backdrop-filter: blur(5px);";
                const spaceBtnStyle = `background: rgba(56, 189, 248, 0.25); border: 1px solid rgba(56, 189, 248, 0.4); color: #e0f2fe; box-shadow: 0 4px 15px rgba(0,0,0,0.3); ${commonBtnStyle}`;
                const profBtnStyle = `background: rgba(241, 245, 249, 0.75); border: 1px solid rgba(226, 232, 240, 0.6); color: #0f172a; box-shadow: 0 2px 5px rgba(0,0,0,0.05); ${commonBtnStyle}`;

                const backToTopStyle = isSpace ? spaceBtnStyle : profBtnStyle;
                const btnTop = errorMessage ? '90px' : '20px';
                const btnRight = isMobile ? '20px' : '180px';
                const themeBtnStyle = isSpace 
                    ? `position: fixed; top: ${btnTop}; right: ${btnRight}; z-index: 2002; padding: 10px 16px; border-radius: 30px; font-size: 12px; ${spaceBtnStyle}`
                    : `position: fixed; top: ${btnTop}; right: ${btnRight}; z-index: 2002; padding: 10px 16px; border-radius: 30px; font-size: 12px; ${profBtnStyle}`;

                const downloadBtnStyle = isSpace 
                    ? spaceBtnStyle 
                    : profBtnStyle;

                // Add Floating Theme Button
                html += `<button onclick="renderMobileView('${isSpace ? 'professional' : 'space'}')" style="${themeBtnStyle}">
                    ${isSpace ? '‚òÄÔ∏è View Professional' : 'ü™ê View Space Theme'}
                </button>`;

                html += `<button id="back-to-top" onclick="document.getElementById('mobile-view').scrollTo({top: 0, behavior: 'smooth'})" style="${backToTopStyle}">‚Üë</button>`;

                html += `<div class="mobile-buttons">
                    ${!isMobile ? `<button onclick="window.print()" style="${downloadBtnStyle}">üñ®Ô∏è Print</button>` : ''}
                    <button onclick="generatePDF('professional')" style="${downloadBtnStyle}">üìÑ Professional PDF</button>
                    <button onclick="generatePDF('space')" style="${downloadBtnStyle}">üöÄ Space PDF</button>
                </div>`;

                container.innerHTML = html;
            };

            // Initial render - Professional (Light) by default
            renderMobileView('professional');
            
        }

        if (isMobile) {
            startFallbackMode();
        } else {

        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        scene.fog = new THREE.FogExp2(0x000000, 0.0008);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(0, 60, 250);

        let webGLRenderer;
        try {
            webGLRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        } catch (e) {
            console.warn("WebGL failed, falling back to static view.");
            startFallbackMode("Hardware Acceleration is disabled or not supported. To see the interactive 3D solar system, please enable <strong>'Use graphics acceleration when available'</strong> in your browser settings and reload the page.");
            throw new Error("WebGL Fallback");
        }
        webGLRenderer.setSize(window.innerWidth, window.innerHeight);
        webGLRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        webGLRenderer.shadowMap.enabled = true;
        webGLRenderer.shadowMap.type = THREE.PCFShadowShadowMap;
        container.appendChild(webGLRenderer.domElement);

        const controls = new OrbitControls(camera, webGLRenderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 5;
        controls.maxDistance = 500;
        if (isMobile) {
            controls.enablePan = false;
            controls.rotateSpeed = 0.5;
        }

        // === LIGHTING ===
        const ambientLight = new THREE.AmbientLight(0x999999, 0.9);
        scene.remove(ambientLight);
        scene.add(ambientLight);
        
        const sunLight = new THREE.PointLight(0xffffff, 6, 2000);
        sunLight.position.set(0, 0, 0);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 4096;
        sunLight.shadow.mapSize.height = 4096;
        scene.remove(sunLight);
        scene.add(sunLight);

        // === MINIMAL GSAP REPLACEMENT ===
        const gsap = {
            to: function(target, config) {
                const startValues = {};
                const endValues = config;
                const duration = (config.duration || 0) * 1000;
                const startTime = Date.now();
                const easeFunc = this.easeInOut;

                Object.keys(endValues).forEach(key => {
                    if (key !== 'duration' && key !== 'ease' && key !== 'onComplete') {
                        startValues[key] = target[key];
                    }
                });

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = easeFunc(progress);

                    Object.keys(startValues).forEach(key => {
                        target[key] = startValues[key] + (endValues[key] - startValues[key]) * eased;
                    });

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else if (config.onComplete) {
                        config.onComplete();
                    }
                };

                animate();
            },
            easeInOut: function(t) {
                return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
            }
        };

        // === TEXTURE GENERATORS ===
        function createCanvasTexture(width, height, drawFn) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            drawFn(ctx, width, height);
            const tex = new THREE.CanvasTexture(canvas);
            tex.colorSpace = THREE.SRGBColorSpace;
            // expose the source canvas for UI snapshot fallback
            tex._canvas = canvas;
            return tex;
        }

        // Red Experience planet with Jupiter-like atmosphere
        function drawRed(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#5a1a1a');
            grad.addColorStop(0.15, '#a02a2a');
            grad.addColorStop(0.3, '#d93a3a');
            grad.addColorStop(0.4, '#ff5555');
            grad.addColorStop(0.5, '#ff4444');
            grad.addColorStop(0.6, '#e63c3c');
            grad.addColorStop(0.7, '#cc3333');
            grad.addColorStop(0.85, '#8b2a2a');
            grad.addColorStop(1, '#5a1a1a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            // Atmospheric bands (dark)
            ctx.globalCompositeOperation = 'multiply';
            for(let i = 0; i < 18; i++) {
                const y = (i / 18) * h;
                ctx.fillStyle = `rgba(0,0,0,${Math.random() * 0.12 + 0.03})`;
                ctx.fillRect(0, y, w, Math.random() * 25 + 12);
            }

            // Large storm/vortex similar to Jupiter's Great Red Spot
            ctx.globalCompositeOperation = 'overlay';
            ctx.fillStyle = 'rgba(180, 40, 40, 0.3)';
            ctx.beginPath();
            ctx.ellipse(w * 0.62, h * 0.58, w * 0.2, h * 0.14, -0.3, 0, Math.PI * 2);
            ctx.fill();

            // Atmospheric swirls
            ctx.globalCompositeOperation = 'screen';
            for(let i = 0; i < 200; i++) {
                ctx.fillStyle = `rgba(255,200,200,${Math.random() * 0.12})`;
                ctx.beginPath();
                ctx.ellipse(Math.random() * w, Math.random() * h, 50 + Math.random() * 130, 12 + Math.random() * 35, Math.random() * Math.PI, 0, Math.PI * 2);
                ctx.fill();
            }

            // Bright highlights for atmospheric reflection
            for(let i = 0; i < 120; i++) {
                ctx.fillStyle = `rgba(255,150,150,${Math.random() * 0.18})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, Math.random() * 18 + 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // BRIGHTER TEXTURE GENERATORS
        // Mars - Even lighter red/orange
        function drawMars(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#8b5a3a');
            grad.addColorStop(0.15, '#b8704a');
            grad.addColorStop(0.3, '#e07855');
            grad.addColorStop(0.5, '#ff9966');
            grad.addColorStop(0.7, '#e07855');
            grad.addColorStop(0.85, '#b8704a');
            grad.addColorStop(1, '#8b5a3a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            ctx.globalCompositeOperation = 'multiply';
            for(let i = 0; i < 15; i++) {
                ctx.fillStyle = `rgba(0,0,0,${Math.random() * 0.1 + 0.02})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 60 + Math.random() * 150, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.globalCompositeOperation = 'screen';
            for(let i = 0; i < 150; i++) {
                ctx.fillStyle = `rgba(255, 180, 120, ${Math.random() * 0.25})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 30 + Math.random() * 80, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Venus - Brighter golden yellow
        function drawVenus(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#b39a5a');
            grad.addColorStop(0.15, '#f5d86f');
            grad.addColorStop(0.3, '#ffeb99');
            grad.addColorStop(0.5, '#ffff99');
            grad.addColorStop(0.7, '#ffeb99');
            grad.addColorStop(0.85, '#f5d86f');
            grad.addColorStop(1, '#b39a5a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            ctx.globalCompositeOperation = 'multiply';
            for(let i = 0; i < 10; i++) {
                const y = (i / 10) * h;
                ctx.fillStyle = `rgba(200, 160, 80, ${Math.random() * 0.08 + 0.02})`;
                ctx.fillRect(0, y, w, Math.random() * 30 + 15);
            }

            ctx.globalCompositeOperation = 'overlay';
            for(let i = 0; i < 150; i++) {
                ctx.fillStyle = `rgba(255, 240, 180, ${Math.random() * 0.2})`;
                ctx.beginPath();
                ctx.ellipse(Math.random() * w, Math.random() * h, 70 + Math.random() * 140, 20 + Math.random() * 40, 0, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Jupiter - Even lighter cream/tan
        function drawJupiter(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#6b5a45');
            grad.addColorStop(0.15, '#b39a7a');
            grad.addColorStop(0.3, '#ddb878');
            grad.addColorStop(0.4, '#e8d9a8');
            grad.addColorStop(0.5, '#ddb878');
            grad.addColorStop(0.6, '#d4a574');
            grad.addColorStop(0.7, '#c49c6a');
            grad.addColorStop(0.85, '#a68a67');
            grad.addColorStop(1, '#8b7a57');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            ctx.globalCompositeOperation = 'multiply';
            for(let i = 0; i < 20; i++) {
                const y = (i / 20) * h;
                ctx.fillStyle = `rgba(0,0,0,${Math.random() * 0.1 + 0.02})`;
                ctx.fillRect(0, y, w, Math.random() * 20 + 10);
            }

            ctx.globalCompositeOperation = 'overlay';
            ctx.fillStyle = 'rgba(240, 140, 100, 0.2)';
            ctx.beginPath();
            ctx.ellipse(w * 0.65, h * 0.55, w * 0.18, h * 0.12, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.globalCompositeOperation = 'screen';
            for(let i = 0; i < 180; i++) {
                ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.15})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, Math.random() * 15 + 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Saturn - Brighter vanilla/cream
        function drawSaturn(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#8b7a5a');
            grad.addColorStop(0.15, '#d9c896');
            grad.addColorStop(0.3, '#f0e8c8');
            grad.addColorStop(0.5, '#fffae6');
            grad.addColorStop(0.7, '#f0e8c8');
            grad.addColorStop(0.85, '#d9c896');
            grad.addColorStop(1, '#8b7a5a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            ctx.globalCompositeOperation = 'multiply';
            for(let i = 0; i < 12; i++) {
                const y = (i / 12) * h;
                ctx.fillStyle = `rgba(140, 120, 80, ${Math.random() * 0.08 + 0.02})`;
                ctx.fillRect(0, y, w, Math.random() * 15 + 8);
            }

            ctx.globalCompositeOperation = 'screen';
            for(let i = 0; i < 150; i++) {
                ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.18})`;
                ctx.beginPath();
                ctx.ellipse(Math.random() * w, Math.random() * h, 60 + Math.random() * 120, 10 + Math.random() * 20, 0, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Uranus - Brighter light cyan
        function drawUranus(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#5a7a9a');
            grad.addColorStop(0.2, '#7aaacc');
            grad.addColorStop(0.35, '#99ccff');
            grad.addColorStop(0.5, '#bbddff');
            grad.addColorStop(0.65, '#99ccff');
            grad.addColorStop(0.8, '#7aaacc');
            grad.addColorStop(1, '#5a7a9a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            ctx.globalCompositeOperation = 'overlay';
            for(let i = 0; i < 25; i++) {
                ctx.fillStyle = `rgba(180, 220, 255, ${Math.random() * 0.2})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 60 + Math.random() * 120, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Neptune - Brighter light blue
        function drawNeptune(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#5a7a9a');
            grad.addColorStop(0.2, '#3399ff');
            grad.addColorStop(0.35, '#66b3ff');
            grad.addColorStop(0.5, '#99ccff');
            grad.addColorStop(0.65, '#66b3ff');
            grad.addColorStop(0.8, '#3399ff');
            grad.addColorStop(1, '#5a7a9a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            ctx.globalCompositeOperation = 'overlay';
            ctx.fillStyle = 'rgba(150, 200, 255, 0.3)';
            ctx.beginPath();
            ctx.arc(w * 0.7, h * 0.4, w * 0.12, 0, Math.PI * 2);
            ctx.fill();

            for(let i = 0; i < 35; i++) {
                ctx.fillStyle = `rgba(200, 230, 255, ${Math.random() * 0.25})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 50 + Math.random() * 100, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Earth-like texture
        function drawEarth(ctx, w, h) {
            ctx.fillStyle = '#1a4a9a';
            ctx.fillRect(0, 0, w, h);

            ctx.fillStyle = '#2d6b3e';
            for(let i = 0; i < 40; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 25 + Math.random() * 100, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            for(let i = 0; i < 120; i++) {
                ctx.beginPath();
                ctx.ellipse(Math.random() * w, Math.random() * h, 30 + Math.random() * 70, 12 + Math.random() * 35, Math.random() * Math.PI, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Moon/Rocky texture
        function drawRocky(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#5a5a5a');
            grad.addColorStop(0.5, '#a8a8a8');
            grad.addColorStop(1, '#6a6a6a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            ctx.globalCompositeOperation = 'multiply';
            for (let i = 0; i < 250; i++) {
                const x = Math.random() * w;
                const y = Math.random() * h;
                const r = Math.random() * 10 + 2;
                
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(0, 0, 0, ${0.2 + Math.random() * 0.35})`;
                ctx.fill();

                ctx.beginPath();
                ctx.arc(x - r/3, y - r/3, r / 2.2, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(200, 200, 200, ${0.15 + Math.random() * 0.25})`;
                ctx.fill();
            }

            ctx.globalCompositeOperation = 'screen';
            for(let i = 0; i < 50; i++) {
                ctx.fillStyle = `rgba(230, 230, 230, ${Math.random() * 0.15})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 40 + Math.random() * 120, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Green planet texture (for Education)
        function drawGreen(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#0d3a1a');
            grad.addColorStop(0.15, '#1d6b2f');
            grad.addColorStop(0.3, '#2d8c42');
            grad.addColorStop(0.5, '#4db85a');
            grad.addColorStop(0.7, '#2d8c42');
            grad.addColorStop(0.85, '#1d6b2f');
            grad.addColorStop(1, '#0d3a1a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            // Vegetation/forest patterns
            ctx.globalCompositeOperation = 'multiply';
            for(let i = 0; i < 20; i++) {
                ctx.fillStyle = `rgba(0,0,0,${Math.random() * 0.2 + 0.05})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 50 + Math.random() * 150, 0, Math.PI * 2);
                ctx.fill();
            }

            // Lighter vegetation highlights
            ctx.globalCompositeOperation = 'screen';
            for(let i = 0; i < 100; i++) {
                ctx.fillStyle = `rgba(100, 200, 100, ${Math.random() * 0.15})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 20 + Math.random() * 60, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Light Green Yellow planet texture
        function drawLightGreenYellow(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#eaff80');
            grad.addColorStop(0.5, '#f7ffcc');
            grad.addColorStop(1, '#eaff80');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            ctx.globalCompositeOperation = 'multiply';
            for(let i = 0; i < 15; i++) {
                const y = (i / 15) * h;
                ctx.fillStyle = `rgba(180, 200, 100, ${Math.random() * 0.1 + 0.02})`;
                ctx.fillRect(0, y, w, Math.random() * 20 + 10);
            }

            ctx.globalCompositeOperation = 'screen';
            for(let i = 0; i < 100; i++) {
                ctx.fillStyle = `rgba(255, 255, 220, ${Math.random() * 0.2})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, Math.random() * 20 + 5, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Yellow moon texture - Brighter
        function drawYellow(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#7a5a2a');
            grad.addColorStop(0.15, '#c4a850');
            grad.addColorStop(0.3, '#e8d966');
            grad.addColorStop(0.5, '#ffeb99');
            grad.addColorStop(0.7, '#e8d966');
            grad.addColorStop(0.85, '#c4a850');
            grad.addColorStop(1, '#7a5a2a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            ctx.globalCompositeOperation = 'multiply';
            for (let i = 0; i < 80; i++) {
                const x = Math.random() * w;
                const y = Math.random() * h;
                const r = Math.random() * 8 + 2;
                
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(0, 0, 0, ${0.1 + Math.random() * 0.15})`;
                ctx.fill();

                ctx.beginPath();
                ctx.arc(x - r/3, y - r/3, r / 2.5, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 200, ${0.15 + Math.random() * 0.2})`;
                ctx.fill();
            }

            ctx.globalCompositeOperation = 'screen';
            for(let i = 0; i < 60; i++) {
                ctx.fillStyle = `rgba(255, 255, 220, ${Math.random() * 0.15})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 30 + Math.random() * 80, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Teal moon texture - Brighter
        function drawTeal(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#3a5a7a');
            grad.addColorStop(0.15, '#5a8aaa');
            grad.addColorStop(0.3, '#7abacc');
            grad.addColorStop(0.5, '#99ddff');
            grad.addColorStop(0.7, '#7abacc');
            grad.addColorStop(0.85, '#5a8aaa');
            grad.addColorStop(1, '#3a5a7a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            ctx.globalCompositeOperation = 'multiply';
            for (let i = 0; i < 100; i++) {
                ctx.fillStyle = `rgba(0, 0, 0, ${0.15 + Math.random() * 0.2})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 60 + Math.random() * 120, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.globalCompositeOperation = 'screen';
            for(let i = 0; i < 70; i++) {
                ctx.fillStyle = `rgba(220, 255, 255, ${Math.random() * 0.15})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 25 + Math.random() * 100, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Blue Education planet texture
        function drawBlue(ctx, w, h) {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#0a2a5a');
            grad.addColorStop(0.15, '#1a5a9a');
            grad.addColorStop(0.3, '#2a7acc');
            grad.addColorStop(0.5, '#4a9aff');
            grad.addColorStop(0.7, '#2a7acc');
            grad.addColorStop(0.85, '#1a5a9a');
            grad.addColorStop(1, '#0a2a5a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            // Water/ocean patterns
            ctx.globalCompositeOperation = 'multiply';
            for(let i = 0; i < 20; i++) {
                ctx.fillStyle = `rgba(0,0,0,${Math.random() * 0.15 + 0.05})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 50 + Math.random() * 150, 0, Math.PI * 2);
                ctx.fill();
            }

            // Cloud highlights
            ctx.globalCompositeOperation = 'screen';
            for(let i = 0; i < 100; i++) {
                ctx.fillStyle = `rgba(150, 200, 255, ${Math.random() * 0.15})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 20 + Math.random() * 60, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Moon surface textures - showing what each moon represents
        function drawEmailSurface(ctx, w, h) {
            // Email represented as an envelope/message surface
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#2a2a3a');
            grad.addColorStop(0.5, '#4a5a7a');
            grad.addColorStop(1, '#2a2a3a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            // Envelope pattern
            ctx.globalCompositeOperation = 'overlay';
            ctx.strokeStyle = 'rgba(255, 200, 100, 0.4)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(w, 0);
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.lineTo(0, 0);
            ctx.stroke();

            // Email lines
            for(let i = 1; i < 6; i++) {
                ctx.strokeStyle = `rgba(200, 200, 255, ${0.3 - i*0.05})`;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(10, h * (i / 6));
                ctx.lineTo(w - 10, h * (i / 6));
                ctx.stroke();
            }

            // Highlight
            ctx.fillStyle = 'rgba(255, 255, 200, 0.2)';
            ctx.fillRect(w * 0.2, h * 0.2, w * 0.6, h * 0.3);
        }

        function drawPhoneSurface(ctx, w, h) {
            // Phone represented as a display/screen surface
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#1a1a2a');
            grad.addColorStop(0.5, '#3a4a5a');
            grad.addColorStop(1, '#1a1a2a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            // Phone screen with grid pattern
            ctx.globalCompositeOperation = 'overlay';
            ctx.strokeStyle = 'rgba(100, 200, 255, 0.3)';
            ctx.lineWidth = 1;
            for(let i = 0; i < 10; i++) {
                ctx.beginPath();
                ctx.moveTo((w / 10) * i, 0);
                ctx.lineTo((w / 10) * i, h);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(0, (h / 10) * i);
                ctx.lineTo(w, (h / 10) * i);
                ctx.stroke();
            }

            // Glowing dots
            ctx.fillStyle = 'rgba(100, 200, 255, 0.5)';
            for(let i = 0; i < 8; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * w * 0.8 + w * 0.1, Math.random() * h * 0.8 + h * 0.1, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawLocationSurface(ctx, w, h) {
            // Location represented as a map/coordinates surface
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#1a3a2a');
            grad.addColorStop(0.5, '#3a6a5a');
            grad.addColorStop(1, '#1a3a2a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            // Map grid
            ctx.globalCompositeOperation = 'overlay';
            ctx.strokeStyle = 'rgba(100, 255, 150, 0.3)';
            ctx.lineWidth = 1;
            for(let i = 0; i < 8; i++) {
                ctx.beginPath();
                ctx.moveTo((w / 8) * i, 0);
                ctx.lineTo((w / 8) * i, h);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(0, (h / 8) * i);
                ctx.lineTo(w, (h / 8) * i);
                ctx.stroke();
            }

            // Location pin
            ctx.fillStyle = 'rgba(255, 100, 100, 0.6)';
            ctx.beginPath();
            ctx.arc(w * 0.5, h * 0.4, 15, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = 'rgba(255, 200, 100, 0.8)';
            ctx.beginPath();
            ctx.arc(w * 0.5, h * 0.4, 8, 0, Math.PI * 2);
            ctx.fill();

            // Coordinate lines
            ctx.strokeStyle = 'rgba(100, 200, 255, 0.4)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, h * 0.4);
            ctx.lineTo(w, h * 0.4);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(w * 0.5, 0);
            ctx.lineTo(w * 0.5, h);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // Texture map for dynamic loading
        const textureMap = {
            "drawRed": drawRed,
            "drawVenus": drawVenus,
            "drawJupiter": drawJupiter,
            "drawBlue": drawBlue,
            "drawLightGreenYellow": drawLightGreenYellow
        };

        // === HELPER FUNCTIONS (MUST BE BEFORE USE) ===
        function createLabel(text, object, isMajor = false) {
            const div = document.createElement('div');
            div.className = isMajor ? 'label major' : 'label';
            div.innerHTML = text;
            div.onclick = (e) => {
                e.stopPropagation();
                focusOnObject(object);
            };
            document.getElementById('ui-layer').appendChild(div);
            labels.push({ div, object });
        }

        // === AUDIO SETUP ===
        function playSound(type) {
            if (!soundEnabled) return;
            const ctx = backgroundAudio ? backgroundAudio.audioContext : new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);

            if (type === 'laser') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            } else if (type === 'comet') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(50, ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.05, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            }
        }

        function initAudio() {
            // tear down any previous audio nodes safely
            if (backgroundAudio) {
                try { backgroundAudio.oscillator.stop(); } catch(e){}
                try { backgroundAudio.oscillator.disconnect(); } catch(e){}
                try { backgroundAudio.gainNode.disconnect(); } catch(e){}
            }

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // vary tone a little for texture, start muted
            oscillator.frequency.setValueAtTime(220 + Math.random() * 220, audioContext.currentTime);
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);

            try { oscillator.start(); } catch(e){ /* already started */ }

            backgroundAudio = { oscillator, gainNode, audioContext };
        }

        window.toggleSound = () => {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('sound-btn');

            if (soundEnabled) {
                btn.textContent = 'üîä Sound On';
                if (!backgroundAudio) initAudio();
                // must resume audio context on user gesture and ramp gain
                const ctx = backgroundAudio.audioContext;
                ctx.resume().then(() => {
                    const now = ctx.currentTime;
                    try {
                        backgroundAudio.gainNode.gain.cancelScheduledValues(now);
                        backgroundAudio.gainNode.gain.setValueAtTime(backgroundAudio.gainNode.gain.value || 0, now);
                        backgroundAudio.gainNode.gain.linearRampToValueAtTime(0.01, now + 0.5);
                    } catch(e) { backgroundAudio.gainNode.gain.value = 0.01; }
                }).catch(()=>{ /* ignore resume errors */ });
            } else {
                btn.textContent = 'üîá Sound Off';
                if (backgroundAudio) {
                    const now = backgroundAudio.audioContext.currentTime;
                    try {
                        backgroundAudio.gainNode.gain.cancelScheduledValues(now);
                        backgroundAudio.gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
                    } catch(e) { backgroundAudio.gainNode.gain.value = 0; }
                }
            }
        };

        // === PDF GENERATION ===
        window.generatePDF = async (theme) => {
            const modal = document.getElementById('pdf-modal');
            const originalText = modal.innerHTML;
            modal.innerHTML = '<div style="color:white;text-align:center">Generating PDF...<br>Please wait.</div>';
            
            // Allow UI to update
            await new Promise(r => setTimeout(r, 100));
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const PAGE_WIDTH = doc.internal.pageSize.getWidth();
            const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
            const margin = 25;
            const contentWidth = PAGE_WIDTH - (margin * 2);
            
            // Helper to strip emojis and non-standard chars to prevent junk characters
            const safeText = (text) => {
                if (!text) return "";
                // Remove common emoji ranges and symbols that might break standard PDF fonts
                return text.replace(/[\u{1F600}-\u{1F6FF}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1F004}\u{1F0CF}\u{1F170}-\u{1F251}\u{1F000}-\u{1F02F}]/gu, '')
                           .replace(/[^\x00-\x7F\u0080-\u00FF\u2010-\u2015\u2022]/g, " ") // Keep basic latin, accents, dashes, bullets
                           .replace(/\s+/g, ' ')
                           .trim();
            };

            // Load Profile Image safely
            let profileImg = null;
            try {
                profileImg = await new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => resolve(img);
                    img.onerror = () => {
                        console.warn("Profile image failed to load (likely CORS). Continuing without it.");
                        resolve(null);
                    };
                    img.src = 'Profile.jpg';
                });
            } catch (e) {
                console.warn("Image load error", e);
            }

            // Theme Config
            const isSpace = theme === 'space';
            const colors = isSpace ? {
                bg: [5, 5, 12], // Deep Space
                text: [240, 240, 255],
                accent: [56, 189, 248], // Cyan
                secondary: [148, 163, 184],
                line: [30, 41, 59]
            } : {
                bg: [255, 255, 255],
                text: [40, 40, 40],
                accent: [41, 128, 185], // Professional Blue
                secondary: [80, 80, 80],
                line: [200, 200, 200]
            };

            const titles = isSpace ? {
                summary: "MISSION OBJECTIVE & PROFILE",
                experience: "FLIGHT LOG & MISSION HISTORY",
                skills: "OPERATIONAL SUBSYSTEMS",
                projects: "DEPLOYED MISSION PAYLOADS",
                education: "ACADEMIC & TRAINING DATA"
            } : {
                summary: "SUMMARY",
                experience: "PROFESSIONAL EXPERIENCE",
                skills: "SKILLS & COMPETENCIES",
                projects: "KEY PROJECTS",
                education: "EDUCATION"
            };

            // Helper to draw background
            const drawBackground = () => {
                doc.setFillColor(...colors.bg);
                doc.rect(0, 0, PAGE_WIDTH, PAGE_HEIGHT, 'F');

                // Page Border
                doc.setDrawColor(...colors.line);
                doc.setLineWidth(0.5);
                doc.rect(15, 15, PAGE_WIDTH - 30, PAGE_HEIGHT - 30, 'S');

                if (isSpace) {
                    // Stars
                    for (let i = 0; i < 150; i++) {
                        const x = Math.random() * PAGE_WIDTH;
                        const y = Math.random() * PAGE_HEIGHT;
                        const r = Math.random() * 0.3 + 0.1;
                        const brightness = Math.floor(Math.random() * 100) + 155;
                        doc.setFillColor(brightness, brightness, brightness);
                        doc.circle(x, y, r, 'F');
                    }

                    // Webb Spikes (Bright Stars)
                    for (let i = 0; i < 6; i++) {
                        const x = Math.random() * PAGE_WIDTH;
                        const y = Math.random() * PAGE_HEIGHT;
                        doc.setDrawColor(255, 255, 255);
                        doc.setLineWidth(0.1);
                        const size = 2 + Math.random() * 2;
                        doc.line(x - size, y, x + size, y);
                        doc.line(x, y - size, x, y + size);
                        doc.line(x - size*0.7, y - size*0.7, x + size*0.7, y + size*0.7);
                        doc.line(x - size*0.7, y + size*0.7, x + size*0.7, y - size*0.7);
                    }
                    
                    // Nebulae
                    const nebulaColors = [[255, 100, 100], [100, 200, 255], [200, 100, 255]];
                    for (let n = 0; n < 3; n++) {
                        const cx = Math.random() * PAGE_WIDTH;
                        const cy = Math.random() * PAGE_HEIGHT;
                        const color = nebulaColors[Math.floor(Math.random() * nebulaColors.length)];
                        doc.setFillColor(...color);
                        for (let p = 0; p < 40; p++) {
                            const angle = Math.random() * Math.PI * 2;
                            const dist = Math.random() * 30 * Math.random();
                            const px = cx + Math.cos(angle) * dist;
                            const py = cy + Math.sin(angle) * dist;
                            if (px > 0 && px < PAGE_WIDTH && py > 0 && py < PAGE_HEIGHT) {
                                doc.circle(px, py, Math.random() * 0.5, 'F');
                            }
                        }
                    }
                }
            };

            // Initial Background
            drawBackground();

            let y = margin;

            // === HEADER ===
            // Image
            let headerTextWidth = contentWidth;
            if (profileImg) {
                const imgSize = 30;
                const imgX = PAGE_WIDTH - margin - imgSize;
                headerTextWidth = contentWidth - imgSize - 5;
                try {
                    doc.addImage(profileImg, 'JPEG', imgX, y, imgSize, imgSize);
                    doc.setDrawColor(...colors.accent);
                    doc.setLineWidth(0.5);
                    doc.rect(imgX, y, imgSize, imgSize);
                } catch (e) {
                    console.warn("Could not add image to PDF (likely tainted canvas)", e);
                }
            }

            // Name & Role
            doc.setFont(isSpace ? "courier" : "helvetica", "bold");
            doc.setFontSize(24);
            doc.setTextColor(...colors.accent);
            
            const nameLines = doc.splitTextToSize(safeText(RESUME_DATA.name).toUpperCase(), headerTextWidth);
            doc.text(nameLines, margin, y + 8);
            const nameHeight = nameLines.length * 8;
            
            doc.setFont(isSpace ? "courier" : "helvetica", "normal");
            doc.setFontSize(12);
            doc.setTextColor(...colors.text);
            const roleLines = doc.splitTextToSize(safeText(RESUME_DATA.role), headerTextWidth);
            doc.text(roleLines, margin, y + 8 + nameHeight);

            // Contact Info
            y += 25;
            doc.setFontSize(9);
            doc.setTextColor(...colors.secondary);
            
            const c = RESUME_DATA.contact;
            const contactItems = [
                c.email ? `EMAIL: ${c.email}` : null,
                c.phone ? `PHONE: ${c.phone}` : null,
                c.location ? `LOC: ${c.location}` : null,
                c.website ? `WEB: ${c.website}` : null,
                c.linkedin ? `IN: ${c.linkedin.replace(/^https?:\/\//, '')}` : null
            ].filter(Boolean);

            doc.text(contactItems.join("   |   "), margin, y);

            y += 5;
            doc.setDrawColor(...colors.line);
            doc.setLineWidth(0.5);
            doc.line(margin, y, PAGE_WIDTH - margin, y);
            y += 8;

            // === SUMMARY ===
            if (RESUME_DATA.pdfSummary || RESUME_DATA.summary) {
                doc.setFont(isSpace ? "courier" : "helvetica", "bold");
                doc.setFontSize(11);
                doc.setTextColor(...colors.accent);
                doc.text(titles.summary, margin, y);
                y += 5;
                
                doc.setFont(isSpace ? "courier" : "helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(...colors.text);
                const summaryText = safeText(isSpace ? (RESUME_DATA.spaceSummary || RESUME_DATA.pdfSummary) : (RESUME_DATA.pdfSummary || RESUME_DATA.summary));
                const splitSummary = doc.splitTextToSize(summaryText, contentWidth);
                doc.text(splitSummary, margin, y);
                y += splitSummary.length * 4.5 + 5;
            }

            // === SECTIONS ===
            const checkPageBreak = (currentY, needed) => {
                if (currentY + needed > PAGE_HEIGHT - margin) {
                    doc.addPage();
                    drawBackground();
                    return margin;
                }
                return currentY;
            };

            const renderSectionTitle = (title, currentY) => {
                currentY = checkPageBreak(currentY, 15);
                doc.setFont(isSpace ? "courier" : "helvetica", "bold");
                doc.setFontSize(12);
                doc.setTextColor(...colors.accent);
                
                if (!isSpace) {
                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, currentY - 4, contentWidth, 6, 'F');
                }
                
                doc.text(title.toUpperCase(), margin, currentY);
                return currentY + 8;
            };
            
            // EXPERIENCE
            const expPlanet = RESUME_DATA.planets.find(p => p.name === "Experience");
            if (expPlanet && expPlanet.moons) {
                y = renderSectionTitle(titles.experience, y);
                
                expPlanet.moons.forEach(job => {
                    const details = isSpace ? (job.spaceDetails || job.pdfDetails || job.moonDetails || {}) : (job.pdfDetails || job.moonDetails || {});
                    const company = safeText(details.company || job.name);
                    const role = safeText(details.role || "");
                    const duration = safeText(details.duration || "");
                    const location = safeText(details.location || "");

                    y = checkPageBreak(y, 15);

                    // Line 1: Company (Left) | Location (Right)
                    doc.setFont(isSpace ? "courier" : "helvetica", "bold");
                    doc.setFontSize(11);
                    doc.setTextColor(...colors.text);
                    doc.text(company, margin, y);
                    
                    doc.setFontSize(9);
                    doc.setTextColor(...colors.secondary);
                    doc.text(location, PAGE_WIDTH - margin, y, { align: "right" });
                    
                    y += 5;

                    // Line 2: Role (Left) | Duration (Right)
                    doc.setFont(isSpace ? "courier" : "helvetica", "italic");
                    doc.setFontSize(10);
                    doc.setTextColor(...colors.text);
                    doc.text(role, margin, y);

                    doc.setFont(isSpace ? "courier" : "helvetica", "normal");
                    doc.setFontSize(9);
                    doc.setTextColor(...colors.secondary);
                    doc.text(duration, PAGE_WIDTH - margin, y, { align: "right" });
                    
                    y += 6;

                    // Achievements / Responsibilities
                    doc.setFontSize(10);
                    doc.setTextColor(...colors.text);
                    
                    const items = [...(details.achievements || []), ...(details.responsibilities || [])];
                    if (items.length === 0 && job.details) {
                        items.push(...job.details.split('\n').slice(1));
                    } else if (items.length === 0 && details.description) {
                        items.push(details.description);
                    }

                    items.forEach(item => {
                        if (!item) return;
                        const cleanItem = safeText(item.replace(/^‚Ä¢\s*/, ''));
                        if (!cleanItem) return;
                        
                        const bullet = "‚Ä¢";
                        const indent = 5;
                        const textWidth = contentWidth - indent;
                        const splitText = doc.splitTextToSize(cleanItem, textWidth);
                        const blockHeight = splitText.length * 4.5;
                        
                        y = checkPageBreak(y, blockHeight);
                        doc.text(bullet, margin, y);
                        doc.text(splitText, margin + indent, y);
                        y += blockHeight + 1;
                    });
                    y += 4;
                });
            }

            // SKILLS
            const skillsPlanet = RESUME_DATA.planets.find(p => p.name === "Skills");
            if (skillsPlanet) {
                y += 2;
                y = renderSectionTitle(titles.skills, y);
                
                doc.setFontSize(10);
                doc.setTextColor(...colors.text);
                
                if (skillsPlanet.moons) {
                    skillsPlanet.moons.forEach(cat => {
                        const details = isSpace ? (cat.spaceDetails || cat.pdfDetails || cat.moonDetails || {}) : (cat.pdfDetails || cat.moonDetails || {});
                        const catTitle = safeText(details.title || cat.name);
                        
                        y = checkPageBreak(y, 10);
                        doc.setFont(undefined, "bold");
                        doc.text(catTitle, margin, y);
                        y += 5;
                        
                        doc.setFont(undefined, "normal");
                        const skills = details.skills || [];
                        skills.forEach(skill => {
                            const cleanSkill = safeText(skill);
                            const splitSkill = doc.splitTextToSize(cleanSkill, contentWidth - 10);
                            y = checkPageBreak(y, splitSkill.length * 4.5);
                            doc.text("‚Ä¢", margin + 3, y);
                            doc.text(splitSkill, margin + 8, y);
                            y += splitSkill.length * 4.5 + 1;
                        });
                        y += 3;
                    });
                }
                y += 5;
            }

            // PROJECTS
            const projPlanet = RESUME_DATA.planets.find(p => p.name === "Projects");
            if (projPlanet && projPlanet.moons) {
                y = renderSectionTitle(titles.projects, y);
                
                projPlanet.moons.forEach(proj => {
                    const details = isSpace ? (proj.spaceDetails || proj.pdfDetails || proj.moonDetails || {}) : (proj.pdfDetails || proj.moonDetails || {});
                    const title = safeText(details.title || proj.name);
                    const desc = safeText(details.description || "");
                    const impact = details.impact ? details.impact.map(i => safeText(i)).join(". ") : "";
                    
                    y = checkPageBreak(y, 15);
                    doc.setFont(undefined, "bold");
                    doc.text(title, margin, y);
                    
                    doc.setFont(undefined, "normal");
                    const fullText = `${desc} Impact: ${impact}`;
                    const split = doc.splitTextToSize(fullText, contentWidth);
                    
                    y += 4;
                    doc.text(split, margin, y);
                    y += split.length * 4 + 3;
                });
                y += 5;
            }

            // EDUCATION
            const eduPlanet = RESUME_DATA.planets.find(p => p.name === "Education");
            if (eduPlanet) {
                y = renderSectionTitle(titles.education, y);
                const d = isSpace ? (eduPlanet.spaceDetails || eduPlanet.pdfDetails || eduPlanet.details || {}) : (eduPlanet.pdfDetails || eduPlanet.details || {});
                
                y = checkPageBreak(y, 10);
                doc.setFont(undefined, "bold");
                
                const degreeLines = doc.splitTextToSize(safeText(d.degree || ""), contentWidth);
                doc.text(degreeLines, margin, y);
                y += degreeLines.length * 5;
                
                doc.setFont(undefined, "normal");
                const eduInfo = `${safeText(d.institution || "")}, ${safeText(d.location || "")} | ${safeText(d.duration || "")}`;
                const eduLines = doc.splitTextToSize(eduInfo, contentWidth);
                doc.text(eduLines, margin, y);
            }

            // Save
            doc.save(`Nur_Dawoodani_Resume_${theme}.pdf`);
            
            // Reset Modal
            modal.innerHTML = originalText;
            modal.style.display = 'none';
        };

        // Update the sky-details panel to parse structured data
        function landOnMoon(moon) {
            const skyDetails = document.getElementById('sky-details');
            const titleEl = document.getElementById('sky-title');
            const contentEl = document.getElementById('sky-content');
            const data = moon.userData.moonDetails || moon.userData.details;

            titleEl.textContent = moon.userData.name;
            let html = '';

            if (typeof data === 'object' && data !== null) {
                // Handle different data structures
                if (data.company) {
                    // Experience data
                    html = `<h3>${data.company}</h3>`;
                    html += `<p><em>${data.role} | ${data.duration}</em></p>`;
                    if (data.industry) html += `<p><strong>Industry:</strong> ${data.industry}</p>`;
                    
                    if (data.achievements) {
                        html += `<p><strong>Major Achievements:</strong></p><ul>`;
                        data.achievements.forEach(achievement => {
                            html += `<li>${achievement}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    if (data.responsibilities) {
                        html += `<p><strong>Core Responsibilities:</strong></p><ul>`;
                        data.responsibilities.forEach(resp => {
                            html += `<li>${resp}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    if (data.products) {
                        html += `<p><strong>Shipped Products:</strong></p><ul>`;
                        data.products.forEach(product => {
                            html += `<li>${product}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    if (data.techStack) {
                        html += `<p><strong>Tech Stack:</strong></p><ul>`;
                        data.techStack.forEach(tech => {
                            html += `<li>${tech}</li>`;
                        });
                        html += `</ul>`;
                    }
                } else if (data.title && data.skills) {
                    // Skills data
                    html = `<h3>${data.title}</h3><ul>`;
                    data.skills.forEach(skill => {
                        html += `<li>${skill}</li>`;
                    });
                    html += `</ul>`;
                } else if (data.title && data.impact) {
                    // Project data
                    html = `<h3>${data.title}</h3>`;
                    if (data.subtitle) html += `<p><strong>${data.subtitle}</strong></p>`;
                    if (data.description) html += `<p>${data.description}</p>`;
                    html += `<p><strong>Impact:</strong></p><ul>`;
                    data.impact.forEach(item => {
                        html += `<li>${item}</li>`;
                    });
                    html += `</ul>`;
                } else if (data.degree) {
                    // Education data
                    html = `<h3>EDUCATION</h3>`;
                    html += `<p><strong>${data.degree}</strong><br>${data.field}</p>`;
                    html += `<p><strong>${data.institution}</strong><br>${data.duration}</p>`;
                } else if (data.method) {
                    // Contact data
                    html = `<h3>${data.method}</h3>`;
                    if (data.link) {
                        html += `<p><a href="${data.link}" style="color:#38bdf8">${data.value}</a></p>`;
                    } else {
                        html += `<p>${data.value}</p>`;
                    }
                }
            } else {
                // Fallback for string data
                html = `<p>${data || "No details available."}</p>`;
            }

            contentEl.innerHTML = html;
            skyDetails.style.display = 'block';
            document.getElementById('overlay-panel').classList.remove('active');
        }

        // === BRIGHTER SUN WITH YELLOW-ORANGE GRADIENT ===
        const sunGeo = new THREE.SphereGeometry(25, 256, 256);
        const sunGradient = document.createElement('canvas');
        sunGradient.width = 256;
        sunGradient.height = 256;
        const sunCtx = sunGradient.getContext('2d');
        const sunGrad = sunCtx.createRadialGradient(128, 128, 0, 128, 128, 128);
        sunGrad.addColorStop(0, '#ffff99');
        sunGrad.addColorStop(0.3, '#ffeb66');
        sunGrad.addColorStop(0.65, '#ffd933');
        sunGrad.addColorStop(1, '#ff9900');
        sunCtx.fillStyle = sunGrad;
        sunCtx.fillRect(0, 0, 256, 256);
        const sunTexture = new THREE.CanvasTexture(sunGradient);
        
        const sunMat = new THREE.MeshBasicMaterial({ 
            map: sunTexture,
            toneMapped: false
        });
        const sun = new THREE.Mesh(sunGeo, sunMat);
        sun.userData = {
            name: RESUME_DATA.name,
            role: RESUME_DATA.role,
            summary: RESUME_DATA.summary,
            isSun: true
        };
        scene.add(sun);
        
        // Make Sun clickable
        clickableObjects.push(sun);

        // Brighter triple-color sun lights
        const sunYellowLight = new THREE.PointLight(0xffff00, 5, 700);
        sunYellowLight.position.set(0, 0, 0);
        scene.add(sunYellowLight);

        const sunGoldenLight = new THREE.PointLight(0xffcc00, 3, 600);
        sunGoldenLight.position.set(0, 0, 0);
        scene.add(sunGoldenLight);

        const sunOrangeLight = new THREE.PointLight(0xff9900, 2, 500);
        sunOrangeLight.position.set(0, 0, 0);
        scene.add(sunOrangeLight);

        createLabel("NUR<br><span style='font-size:0.6em; opacity:0.8'>BA</span>", sun, true);

        // === IMPROVED STARFIELD WITH CIRCULAR STARS ===
        const starsGeo = new THREE.BufferGeometry();
        const starsCount = 10000;
        const starPositions = new Float32Array(starsCount * 3);
        const starColors = new Float32Array(starsCount * 3);
        const starSizes = new Float32Array(starsCount);

        const starColorChoices = [
            new THREE.Color(0xffffff),   // white
            new THREE.Color(0xffffcc),   // yellow
            new THREE.Color(0xccccff),   // blue
            new THREE.Color(0xffcccc),   // red
            new THREE.Color(0xccffcc),   // green
            new THREE.Color(0xffccdd),   // pink
            new THREE.Color(0xccffff),   // cyan
            new THREE.Color(0xffffaa)    // pale yellow
        ];

        for(let i = 0; i < starsCount; i++) {
            starPositions[i * 3] = (Math.random() - 0.5) * 2000;
            starPositions[i * 3 + 1] = (Math.random() - 0.5) * 2000;
            starPositions[i * 3 + 2] = (Math.random() - 0.5) * 2000;

            const col = starColorChoices[Math.floor(Math.random() * starColorChoices.length)];
            starColors[i * 3] = col.r;
            starColors[i * 3 + 1] = col.g;
            starColors[i * 3 + 2] = col.b;

            starSizes[i] = Math.random() * 2.5 + 0.8;
        }

        starsGeo.setAttribute('position', new THREE.BufferAttribute(starPositions, 3));
        starsGeo.setAttribute('color', new THREE.BufferAttribute(starColors, 3));
        starsGeo.setAttribute('size', new THREE.BufferAttribute(starSizes, 1));

        const starsMat = new THREE.PointsMaterial({
            size: 2,
            vertexColors: true,
            sizeAttenuation: true,
            transparent: true,
            opacity: 0.9,
            fog: false,
            alphaTest: 0.5
        });

        const starTexture = new THREE.CanvasTexture((() => {
            const cvs = document.createElement('canvas');
            cvs.width = 64;
            cvs.height = 64;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(32, 32, 28, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.beginPath();
            ctx.arc(32, 32, 20, 0, Math.PI * 2);
            ctx.fill();
            return cvs;
        })());

        starsMat.map = starTexture;
        const starMesh = new THREE.Points(starsGeo, starsMat);
        starMesh.layers.set(0);
        scene.add(starMesh);

        // === IMPROVED REALISTIC GALAXIES WITH VARIED COLORS ===
        function createGalaxy(colorScheme = 0) {
            const colors = [
                { core: 'rgba(255, 200, 100, 0.4)', arms: 'rgba(255, 150, 200, 0.3)', wisps: 'rgba(200, 100, 255, 0.15)' },
                { core: 'rgba(150, 200, 255, 0.4)', arms: 'rgba(100, 200, 255, 0.3)', wisps: 'rgba(200, 200, 255, 0.15)' },
                { core: 'rgba(200, 100, 200, 0.4)', arms: 'rgba(150, 100, 255, 0.3)', wisps: 'rgba(150, 50, 255, 0.15)' },
                { core: 'rgba(255, 150, 100, 0.4)', arms: 'rgba(255, 100, 50, 0.3)', wisps: 'rgba(255, 150, 100, 0.15)' }
            ];
            
            const color = colors[colorScheme % colors.length];
            
            const texture = createCanvasTexture(512, 512, (ctx, w, h) => {
                // Realistic galaxy with disk
                const coreGrad = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w/2);
                coreGrad.addColorStop(0, color.core);
                coreGrad.addColorStop(0.3, color.core.replace('0.4', '0.25'));
                coreGrad.addColorStop(0.6, color.core.replace('0.4', '0.1'));
                coreGrad.addColorStop(1, 'rgba(0, 0, 0, 0)');
                ctx.fillStyle = coreGrad;
                ctx.fillRect(0, 0, w, h);

                // Realistic spiral arms
                ctx.globalCompositeOperation = 'lighter';
                for(let arm = 0; arm < 4; arm++) {
                    for(let i = 0; i < 100; i++) {
                        const t = i / 100;
                        const angle = arm * Math.PI / 2 + t * Math.PI * 4;
                        const r = t * w * 0.45;
                        const x = w/2 + Math.cos(angle) * r;
                        const y = h/2 + Math.sin(angle) * r;
                        
                        const opacity = (1 - t * 0.8);
                        ctx.fillStyle = color.arms.replace(/[\d.]+\)$/, `${opacity * 0.3})`);
                        ctx.beginPath();
                        ctx.arc(x, y, 15 + t * 20, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                // Dust lanes
                ctx.globalCompositeOperation = 'multiply';
                const dustGrad = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w/2);
                dustGrad.addColorStop(0, 'rgba(0, 0, 0, 0)');
                dustGrad.addColorStop(0.5, 'rgba(0, 0, 0, 0.15)');
                dustGrad.addColorStop(1, 'rgba(0, 0, 0, 0)');
                ctx.fillStyle = dustGrad;
                ctx.fillRect(0, 0, w, h);

                // Star clusters
                ctx.globalCompositeOperation = 'screen';
                for(let i = 0; i < 100; i++) {
                    const x = Math.random() * w;
                    const y = Math.random() * h;
                    ctx.fillStyle = color.wisps.replace(/[\d.]+\)$/, `${Math.random() * 0.3})`);
                    ctx.beginPath();
                    ctx.arc(x, y, Math.random() * 3 + 1, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            const spriteMat = new THREE.SpriteMaterial({ 
                map: texture, 
                transparent: true, 
                sizeAttenuation: true,
                fog: true
            });
            const sprite = new THREE.Sprite(spriteMat);
            sprite.scale.set(250, 250, 1);
            return sprite;
        }

        // Add realistic galaxies with varied colors
        const galaxyPositions = [
            { x: 600, y: 400, z: -1200, color: 0 },
            { x: -700, y: -300, z: -1400, color: 1 },
            { x: 400, y: -600, z: -1100, color: 2 },
            { x: -500, y: 500, z: -1300, color: 3 },
            { x: 800, y: -400, z: -1500, color: 0 },
            { x: -300, y: 700, z: -1000, color: 1 },
            { x: 300, y: 200, z: -1250, color: 2 }
        ];

        galaxyPositions.forEach((pos, idx) => {
            const galaxy = createGalaxy(pos.color);
            galaxy.position.set(pos.x, pos.y, pos.z);
            scene.add(galaxy);
        });

        // === CREATE PLANETS ===
        RESUME_DATA.planets.forEach((data, idx) => {
            const config = {
                ...data,
                texture: textureMap[data.texture] || drawRed,
                inclination: data.inclination || 0.2,
                hasRings: data.hasRings !== undefined ? data.hasRings : false
            };

            // Spiral orbit with inclination
            const orbitGroup = new THREE.Group();
            orbitGroup.rotation.x = config.inclination;
            scene.add(orbitGroup);

            // Orbit path visualization - MORE VISIBLE
            const pathGeo = new THREE.BufferGeometry();
            const pathPoints = [];
            for(let i = 0; i <= 256; i++) {
                const angle = (i / 256) * Math.PI * 2;
                pathPoints.push(
                    Math.cos(angle) * config.distance,
                    0,
                    Math.sin(angle) * config.distance
                );
            }
            pathGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(pathPoints), 3));
            const pathMat = new THREE.LineBasicMaterial({ 
                color: 0xaabbff, 
                transparent: true, 
                opacity: 0.5,
                linewidth: 2
            });
            const path = new THREE.Line(pathGeo, pathMat);
            orbitGroup.add(path);

            const geometry = new THREE.SphereGeometry(config.size, 128, 128);
            const texture = createCanvasTexture(2048, 1024, config.texture);
            
            const material = new THREE.MeshPhongMaterial({
                map: texture,
                shininess: 20,
                emissive: 0x050505,
                emissiveIntensity: 0.05,
                side: THREE.FrontSide,
                flatShading: false
            });

            const planet = new THREE.Mesh(geometry, material);
            planet.castShadow = true;
            planet.receiveShadow = true;
            planet.userData = { ...data, isPlanet: true };

            const planetPivot = new THREE.Group();
            planetPivot.rotation.y = Math.random() * Math.PI * 2; // Randomize initial orbit position
            planetPivot.add(planet);
            planet.position.x = config.distance;
            orbitGroup.add(planetPivot);

            objects.push({ mesh: orbitGroup, speed: config.speed, type: 'orbit' });
            objects.push({ mesh: planet, speed: 0.003, type: 'rotate' });
            clickableObjects.push(planet);
            createLabel(data.name, planet);

            // Rings for Saturn
            if (config.hasRings) {
                const ringGeo = new THREE.RingGeometry(config.size + 2, config.size + 6, 64);
                const ringMat = new THREE.MeshStandardMaterial({
                    color: 0xfff5e1,
                    transparent: true,
                    opacity: 0.95,
                    side: THREE.DoubleSide,
                    roughness: 0.6,
                    emissive: 0x0a0a0a,
                    emissiveIntensity: 0.05
                });
                const ring = new THREE.Mesh(ringGeo, ringMat);
                ring.rotation.x = Math.PI / 3.5;
                ring.receiveShadow = true;
                planet.add(ring);
            }

            // Moons
            if (data.moons) {
                data.moons.forEach((moonData, moonIdx) => {
                    const moonGeo = new THREE.SphereGeometry(moonData.size, 64, 64);
                    
                    // Determine moon texture based on planet and moon type
                    let moonTexture;
                    if (idx === 1) { // Skills planet - Analytics/Management colors
                        moonTexture = moonIdx % 2 === 0 ? 
                            createCanvasTexture(1024, 1024, drawYellow) : 
                            createCanvasTexture(1024, 1024, drawTeal);
                    } else if (idx === 3) { // Education planet - Contact info surfaces
                        moonTexture = moonIdx % 3 === 0 ? 
                            createCanvasTexture(1024, 1024, drawEmailSurface) : 
                            moonIdx % 3 === 1 ?
                            createCanvasTexture(1024, 1024, drawPhoneSurface) :
                            createCanvasTexture(1024, 1024, drawLocationSurface);
                    } else {
                        moonTexture = createCanvasTexture(1024, 1024, drawRocky);
                    }

                    const moonMat = new THREE.MeshPhongMaterial({
                        map: moonTexture,
                        shininess: 4,
                        emissive: 0x151515,
                        emissiveIntensity: 0.15,
                        side: THREE.FrontSide
                    });
                    const moon = new THREE.Mesh(moonGeo, moonMat);
                    moon.castShadow = true;
                    moon.receiveShadow = true;
                    moon.userData = { 
                        ...moonData, 
                        isMoon: true, 
                        parentPlanet: planet,
                        name: moonData.name,
                        moonDetails: moonData.moonDetails || ""
                    };

                    // Create moon orbit - separate from planet
                    const moonOrbitGroup = new THREE.Group();
                    moonOrbitGroup.position.copy(planet.position);
                    
                    const moonPivot = new THREE.Group();
                    moonPivot.add(moon);
                    moon.position.x = moonData.distance;
                    moonOrbitGroup.add(moonPivot);
                    
                    orbitGroup.add(moonOrbitGroup);

                    // SLOWER MOON SPEEDS - proper orbiting
                    objects.push({ mesh: moonPivot, speed: moonData.speed * 0.3, type: 'orbit' });
                    objects.push({ mesh: moon, speed: 0.005, type: 'rotate' });
                    clickableObjects.push(moon);
                    createLabel(moonData.name, moon);
                });
            }

            // === ADD SPACESHIP TO SKILLS PLANET ===
            if (data.name === "Skills") {
                const shipGroup = new THREE.Group();
                
                // Body
                const bodyGeo = new THREE.ConeGeometry(1.5, 6, 8);
                bodyGeo.rotateX(Math.PI / 2);
                const bodyMat = new THREE.MeshPhongMaterial({ color: 0xeeeeee, shininess: 100 });
                const body = new THREE.Mesh(bodyGeo, bodyMat);
                shipGroup.add(body);

                // Wings
                const wingGeo = new THREE.BoxGeometry(4, 0.2, 2);
                const wingMat = new THREE.MeshPhongMaterial({ color: 0xff3333 });
                const wings = new THREE.Mesh(wingGeo, wingMat);
                wings.position.set(0, 0, 1);
                shipGroup.add(wings);

                // Engine glow
                const engineGeo = new THREE.SphereGeometry(0.6, 8, 8);
                const engineMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                const engine = new THREE.Mesh(engineGeo, engineMat);
                engine.position.set(0, 0, 3);
                shipGroup.add(engine);
                
                shipGroup.position.set(config.size + 8, 0, 0);
                shipGroup.rotation.y = Math.PI; // Face forward
                shipGroup.userData = { isSpaceship: true, name: "Spaceship" };
                clickableObjects.push(shipGroup);
                
                // Add to planet pivot so it orbits with the planet
                planetPivot.add(shipGroup);
                
                // Animate spaceship separately if needed, but adding to planetPivot makes it orbit the planet
                // To make it orbit independently around the planet:
                const shipOrbit = new THREE.Group();
                shipOrbit.add(shipGroup);
                planet.add(shipOrbit); // Add to planet so it moves with it
                objects.push({ mesh: shipOrbit, speed: 0.02, type: 'rotate' });
            }
        });

        // === INTERACTION ===
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('mousemove', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        });

        window.addEventListener('click', onMouseClick);

        function onMouseClick() {
            raycaster.setFromCamera(mouse, camera);
            // Recursive true to hit parts of the spaceship group
            const intersects = raycaster.intersectObjects(clickableObjects, true);
            
            if (intersects.length > 0) {
                // Traverse up to find the object with userData (like the spaceship group)
                let target = intersects[0].object;
                while(target.parent && !target.userData.isSpaceship && !target.userData.isPlanet && !target.userData.isMoon) { target = target.parent; }
                
                if (target.userData.isSpaceship) {
                    fireLasers(target);
                } else {
                    focusOnObject(target);
                }
            } else {
                // Clicked on empty space
                resetView();
            }
        }

        // === INTERACTION HELPERS & OVERLAY ===
        // add focus / overlay functions (show moon surface + details)
        function focusOnObject(object) {
        	if (object && object.userData && object.userData.isSun) {
                focusedObject = null; // Disable auto-tracking for Sun view
                showSunProfile();
                
                isSunView = true;
                controls.enableZoom = false;
                controls.maxDistance = 20; // Keep inside Sun (radius 25)
                controls.minDistance = 0.1;

                // Move camera inside the sun
                gsap.to(camera.position, { x: 0, y: 0, z: 1, duration: 1.5 });
                gsap.to(controls.target, { x: 0, y: 0, z: 0, duration: 1.5 });
                return;
            }

        	focusedObject = object;
        	if (object && object.userData && (object.userData.isMoon || object.userData.isPlanet)) {
        		landOnMoon(object);
        	} else {
                // Hide sky details if not a moon
                document.getElementById('sky-details').style.display = 'none';
                // Show side panel for planets
                if (object && object.userData && object.userData.isPlanet) {
                    showMoonDetails(object); // Reuse this for planets too if needed, or keep existing behavior
                }
        	}

        	// also ensure controls target will follow (animate a bit)
        	if (object) {
        		// if the clicked object is a mesh inside a pivot, use world position
        		const targetPos = new THREE.Vector3();
        		object.getWorldPosition(targetPos);
        		controls.target.copy(targetPos);
                
                // If it's a moon, zoom in close
                if (object.userData.isMoon) {
                    const offset = new THREE.Vector3(object.geometry.parameters.radius * 4, 2, 2);
                    const camPos = targetPos.clone().add(offset);
                    gsap.to(camera.position, { x: camPos.x, y: camPos.y, z: camPos.z, duration: 1.5 });
                }
        	}
        }

        function showSunProfile() {
            const skyDetails = document.getElementById('sky-details');
            const titleEl = document.getElementById('sky-title');
            const contentEl = document.getElementById('sky-content');
            
            titleEl.textContent = RESUME_DATA.name;
            
            const aboutText = "Lead Business Analyst with 18+ years of experience driving digital transformation and business performance. Expert in leading cross-functional teams within Agile/ SAFe environments to deliver high-scale guest-facing features. Proven track record of bridging the gap between complex technical architecture and multi-million dollar business value.";
            
            let html = `
                <div style="text-align: left; max-width: 600px; margin: 0 auto; font-size: 15px; white-space: normal;">
                    <h3 style="color: #38bdf8; margin-top: 0; text-align: center;">${RESUME_DATA.role}</h3>
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);">
                        <p style="margin: 5px 0;"><strong>üìß Email:</strong> <a href="mailto:${RESUME_DATA.contact.email}" style="color: #fff; text-decoration: none;">${RESUME_DATA.contact.email}</a></p>
                        <p style="margin: 5px 0;"><strong>üì± Phone:</strong> ${RESUME_DATA.contact.phone}</p>
                        <p style="margin: 5px 0;"><strong>üìç Location:</strong> ${RESUME_DATA.contact.location}</p>
                        <p style="margin: 5px 0;"><strong>üîó LinkedIn:</strong> <a href="https://${RESUME_DATA.contact.linkedin}" target="_blank" style="color: #38bdf8; text-decoration: none;">${RESUME_DATA.contact.linkedin}</a></p>
                        <p style="margin: 5px 0;"><strong>üåê Website:</strong> <a href="https://${RESUME_DATA.contact.website}" target="_blank" style="color: #38bdf8; text-decoration: none;">${RESUME_DATA.contact.website}</a></p>
                    </div>
                    <h4 style="color: #e2e8f0; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 15px;">About Me</h4>
                    <p style="line-height: 1.6; color: #cbd5e1;">${aboutText}</p>
                </div>
            `;
            
            contentEl.innerHTML = html;
            skyDetails.style.display = 'block';
            document.getElementById('overlay-panel').classList.remove('active');
        }

        // show moon UI panel with surface image and text
        function showMoonDetails(moon) {
            const panel = document.getElementById('overlay-panel');
            const title = document.getElementById('panel-title');
            const subtitle = document.getElementById('panel-subtitle');
            const content = document.getElementById('panel-content');

            const moonName = (moon.userData && moon.userData.name) || moon.name || 'Moon';
            const parentName = (moon.userData && moon.userData.parentPlanet && moon.userData.parentPlanet.userData && moon.userData.parentPlanet.userData.name) || '';

            title.textContent = moonName;
            subtitle.textContent = parentName;
            
            // robustly obtain a snapshot from the moon texture (canvas or image)
            let imgSrc = '';
            const tex = moon.material && moon.material.map;
            const sourceCanvas = tex && (tex._canvas || tex.image);
            if (sourceCanvas && sourceCanvas.toDataURL) {
                try { imgSrc = sourceCanvas.toDataURL(); } catch(e) { imgSrc = ''; }
            } else if (tex && tex.image && tex.image.src) {
                imgSrc = tex.image.src;
            }

            const detailsText = moon.userData.moonDetails || moon.userData.details || '';
            const imgHtml = imgSrc ? `<img src="${imgSrc}" style="width:100%;border-radius:8px;margin-bottom:12px;display:block">` : '';
            content.innerHTML = `${imgHtml}<div style="white-space:pre-wrap;margin:0;font-family:inherit;color:#dbeafe">${detailsText}</div>`;

            panel.classList.add('active');
        }

        // close overlay
        function closeOverlay() {
        	const panel = document.getElementById('overlay-panel');
        	panel.classList.remove('active');
        }

        // basic helpers to avoid missing-function errors
        function resetView() {
            if (isSunView) {
                isSunView = false;
                controls.enableZoom = true;
                controls.maxDistance = 500;
                controls.minDistance = 5;
                camera.fov = 60;
                camera.updateProjectionMatrix();
            }
        	focusedObject = null;
        	controls.target.set(0, 0, 0);
            document.getElementById('sky-details').style.display = 'none';
        	gsap.to(camera.position, { x: 0, y: 60, z: 250, duration: 0.8 });
            closeOverlay();
        }

        // small html-escape helper
        function escapeHtml(str) {
        	if (!str) return '';
        	return String(str)
        		.replace(/&/g, '&amp;')
        		.replace(/</g, '&lt;')
        		.replace(/>/g, '&gt;')
        		.replace(/"/g, '&quot;')
        		.replace(/'/g, '&#039;');
        }

        window.addEventListener('wheel', (e) => {
            if (isSunView) {
                // Telescope zoom (FOV)
                let newFov = camera.fov + (e.deltaY * 0.05);
                newFov = Math.max(10, Math.min(60, newFov));
                camera.fov = newFov;
                camera.updateProjectionMatrix();
            }
        });

        // === ANIMATION LOOP ===
        const clock = new THREE.Clock();

        function spawnComet() {
            const geo = new THREE.SphereGeometry(1.5, 8, 8);
            const mat = new THREE.MeshBasicMaterial({ color: 0xaaddff });
            const mesh = new THREE.Mesh(geo, mat);
            
            const x = (Math.random() - 0.5) * 800;
            const y = (Math.random() - 0.5) * 400;
            const z = (Math.random() - 0.5) * 800;
            mesh.position.set(x, y, z);
            
            const targetX = (Math.random() - 0.5) * 200;
            const targetY = (Math.random() - 0.5) * 100;
            const targetZ = (Math.random() - 0.5) * 200;
            const velocity = new THREE.Vector3(targetX - x, targetY - y, targetZ - z).normalize().multiplyScalar(3);
            
            scene.add(mesh);
            comets.push({ mesh, velocity, life: 400 });
            playSound('comet');
        }

        function fireLasers(ship) {
            const pos = new THREE.Vector3();
            ship.getWorldPosition(pos);
            const quat = new THREE.Quaternion();
            ship.getWorldQuaternion(quat);
            
            const laserGeo = new THREE.CylinderGeometry(0.2, 0.2, 10, 8);
            laserGeo.rotateX(Math.PI / 2);
            const laserMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            
            const l1 = new THREE.Mesh(laserGeo, laserMat);
            const l2 = new THREE.Mesh(laserGeo, laserMat);
            
            const offset = new THREE.Vector3(2, 0, 0).applyQuaternion(quat);
            l1.position.copy(pos).add(offset);
            l1.quaternion.copy(quat);
            l2.position.copy(pos).sub(offset);
            l2.quaternion.copy(quat);
            
            scene.add(l1);
            scene.add(l2);
            
            const velocity = new THREE.Vector3(0, 0, 10).applyQuaternion(quat);
            lasers.push({ mesh: l1, velocity, life: 100 });
            lasers.push({ mesh: l2, velocity, life: 100 });
            playSound('laser');
        }

        function animate() {
            requestAnimationFrame(animate);

            // Sun Pulse
            const time = Date.now() * 0.001;
            sun.scale.setScalar(1 + Math.sin(time * 2) * 0.02);
            sunLight.intensity = 6 + Math.sin(time * 3) * 0.5;

            // Rotate orbits and planets
            objects.forEach(obj => {
                if (obj.type === 'orbit') {
                    obj.mesh.rotation.y += obj.speed;
                } else if (obj.type === 'rotate') {
                    obj.mesh.rotation.y += obj.speed;
                }
            });

            // Comets
            if (Math.random() < 0.005) spawnComet();
            for (let i = comets.length - 1; i >= 0; i--) {
                const c = comets[i];
                c.mesh.position.add(c.velocity);
                
                // Spawn particles
                if (c.life % 2 === 0) {
                    const pGeo = new THREE.BufferGeometry();
                    pGeo.setAttribute('position', new THREE.Float32BufferAttribute([c.mesh.position.x, c.mesh.position.y, c.mesh.position.z], 3));
                    const pMat = new THREE.PointsMaterial({ color: 0xaaddff, size: 0.5, transparent: true });
                    const p = new THREE.Points(pGeo, pMat);
                    scene.add(p);
                    cometParticles.push({ mesh: p, life: 50 });
                }

                c.life--;
                if (c.life <= 0) {
                    scene.remove(c.mesh);
                    comets.splice(i, 1);
                }
            }

            // Comet Particles
            for (let i = cometParticles.length - 1; i >= 0; i--) {
                const p = cometParticles[i];
                p.life--;
                if (p.mesh.material) {
                    p.mesh.material.opacity = p.life / 50;
                }
                if (p.life <= 0) {
                    scene.remove(p.mesh);
                    if (p.mesh.geometry) p.mesh.geometry.dispose();
                    if (p.mesh.material) p.mesh.material.dispose();
                    cometParticles.splice(i, 1);
                }
            }

            // Lasers
            for (let i = lasers.length - 1; i >= 0; i--) {
                const l = lasers[i];
                l.mesh.position.add(l.velocity);
                l.life--;
                if (l.life <= 0) {
                    scene.remove(l.mesh);
                    lasers.splice(i, 1);
                }
            }

            // Update labels
            labels.forEach(item => {
                const pos = new THREE.Vector3();
                item.object.getWorldPosition(pos);
                pos.project(camera);
                
                const x = (pos.x * 0.5 + 0.5) * window.innerWidth;
                const y = (pos.y * -0.5 + 0.5) * window.innerHeight;
                
                // Hide Sun label if camera is inside/very close to Sun
                if (item.object.userData.isSun && camera.position.length() < 20) {
                    item.div.style.display = 'none';
                    return;
                }

                if (pos.z > 1) {
                    item.div.style.display = 'none';
                } else {
                    item.div.style.display = 'block';
                    item.div.style.left = `${x}px`;
                    item.div.style.top = `${y}px`;
                }
            });

            if (focusedObject) {
                const targetPos = new THREE.Vector3();
                focusedObject.getWorldPosition(targetPos);
                controls.target.lerp(targetPos, 0.05);
            }

            controls.update();
            webGLRenderer.render(scene, camera);
        }

        // === RESIZE ===
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            webGLRenderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // === INITIALIZATION ===
        setTimeout(() => {
            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                animate();
            }, 1000);
        }, 1000);
        }
    </script>
</body>


</html>